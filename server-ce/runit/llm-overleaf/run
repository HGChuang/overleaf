#!/bin/bash

# Enable Node inspector when DEBUG_NODE=true (unique port for llm)
NODE_PARAMS=""
if [ "$DEBUG_NODE" == "true" ]; then
	echo "running debug - llm"
	NODE_PARAMS="--inspect=0.0.0.0:30120"
fi

# Load shared Overleaf environment (DB/Redis, config paths, etc.)
source /etc/overleaf/env.sh

# Propagate redis/mongo connection URLs expected by LLM if not explicitly set
if [ -z "$REDIS_URL" ] && [ -n "$REDIS_HOST" ]; then
	export REDIS_URL="redis://$REDIS_HOST:${REDIS_PORT:-6379}"
fi
if [ -z "$MONGO_URL" ] && [ -n "$OVERLEAF_MONGO_URL" ]; then
	# Use Overleaf's mongo URL; append replicaSet if not present and env hints it's enabled
	case "$OVERLEAF_MONGO_URL" in
		*replicaSet=*) export MONGO_URL="$OVERLEAF_MONGO_URL" ;;
		*) export MONGO_URL="${OVERLEAF_MONGO_URL}?replicaSet=${MONGO_REPLICA_SET_NAME:-overleaf}" ;;
	esac
fi

# Bind service listen address (default 0.0.0.0 if not set elsewhere)
export LISTEN_ADDRESS=${LISTEN_ADDRESS:-0.0.0.0}

# Start the LLM service as www-data; logs to /var/log/overleaf/llm.log
exec /sbin/setuser www-data /usr/bin/node $NODE_PARAMS /overleaf/services/llm/app.js >> /var/log/overleaf/llm.log 2>&1

